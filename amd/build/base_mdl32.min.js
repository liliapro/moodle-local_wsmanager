/**
 * Base actions for Moodle >=3.2
 *
 * @module     local_wsmanager/base_mdl32
 * @copyright  2023 Lilia Smirnova <lilia.pro@protonmail.com>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_wsmanager/base_mdl32",["jquery","core/ajax","core/modal_factory","core/modal_events"],(function(jQuery,ajax,ModalFactory,ModalEvents){return{local_wsmanager_webservice_nav_title:function(webserviceid){ajax.call([{methodname:"local_wsmanager_webservice_nav_title",args:{webserviceid:webserviceid}}])[0].then((function(response){jQuery("#local_wsmanager_tab_link_webservice_"+webserviceid).html(response)}))},local_wsmanager_users_table_output:function(webserviceid){return ajax.call([{methodname:"local_wsmanager_webservice_users_table_output",args:{webserviceid:webserviceid}}])[0].then((function(res){jQuery("#local_wsmanager_webservice_users_table_"+webserviceid).html(res)}))},local_wsmanager_webservice_functions_get_params:function(webserviceid,functionname,sep1,sep2,sep3,sep4){var ret="";return jQuery('[id*="local_wsmanager_ws_fn_param_'+webserviceid+"_"+functionname+'"]').each((function(){var $this=jQuery(this),arr=$this.attr("id").replace("local_wsmanager_ws_fn_param_"+webserviceid+"_"+functionname,"").split("_");ret+=webserviceid+sep1+functionname+sep1+arr[1]+sep1+$this.val()+sep4})),ret},local_wsmanager_request_info:function(webserviceid,functionname,params,method,protocol,restformat,token){method||(method=jQuery("#local_wsmanager_external_function_handle_method_"+webserviceid+"_"+functionname+" select").val()),protocol||(protocol=jQuery("#local_wsmanager_external_function_handle_protocol_"+webserviceid+"_"+functionname+" select").val()),restformat||(restformat=jQuery("#local_wsmanager_external_function_handle_restformat_"+webserviceid+"_"+functionname+" select").val()),token||(token=jQuery("#local_wsmanager_external_function_handle_token_"+webserviceid+"_"+functionname+" select option:selected").text()),ajax.call([{methodname:"local_wsmanager_request_info",args:{webserviceid:webserviceid,functionname:functionname,params:params,method:method,protocol:protocol,restformat:restformat,token:token}}])[0].then((function(res){jQuery("#local_wsmanager_request_info_"+webserviceid+"_"+functionname).html(res)}))},local_wsmanager_external_function_handle_output:function(functionname,webserviceid){return ajax.call([{methodname:"local_wsmanager_external_function_handle_output",args:{functionname:functionname,webserviceid:webserviceid}}])[0].then((function(res){return res}))},init:function(sep1,sep2,sep3,sep4){var ctx=this;jQuery("body").on("change",'[data-switch="webservice"]',(function(event){var $this=jQuery(this),webserviceid=parseInt($this.data("webserviceid")),instance=$this.data("instance"),name=$this.data("name");return $this.is(":checked")?ajax.call([{methodname:"local_wsmanager_webservice_state_switch",args:{webserviceid:webserviceid,instance:instance}}])[0].then((function(response){switch(instance){case"restrictedusers":ctx.local_wsmanager_users_table_output(webserviceid);break;case"enabled":ctx.local_wsmanager_webservice_nav_title(webserviceid),jQuery("#local_wsmanager_webservice_row_"+webserviceid).removeClass("local_wsmanager_webservice_row_danger"),jQuery("#local_wsmanager_webservice_name_"+webserviceid).attr("disabled",!1)}})):ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:M.str.moodle.disable,body:M.str.moodle.disable+"<strong>"+name+"</strong><br>"+M.str.moodle.areyousure}).then((function(modal){modal.setButtonText("save",M.str.moodle.disable),modal.getRoot().on(ModalEvents.save,(function(e){e.preventDefault(),ajax.call([{methodname:"local_wsmanager_webservice_state_switch",args:{webserviceid:webserviceid,instance:instance}}])[0].then((function(response){switch(instance){case"restrictedusers":ctx.local_wsmanager_users_table_output(webserviceid);break;case"enabled":ctx.local_wsmanager_webservice_nav_title(webserviceid),jQuery("#local_wsmanager_webservice_row_"+webserviceid).addClass("local_wsmanager_webservice_row_danger"),jQuery("#local_wsmanager_webservice_name_"+webserviceid).attr("disabled",!0)}})),modal.hide()})),modal.getRoot().on(ModalEvents.cancel,(function(){$this.prop("checked",!0),modal.hide()})),modal.show()})),!1})).on("click",".local_wsmanager_external_function_handle_wrapper",(function(event){var $this=jQuery(this),webserviceid=parseInt($this.data("webserviceid")),functionname=$this.data("functionname");return event.preventDefault(),ModalFactory.create({type:ModalFactory.types.DEFAULT,large:!0,title:M.str.local_wsmanager.test,body:ctx.local_wsmanager_external_function_handle_output(functionname,webserviceid)}).then((function(modal){modal.show()})),!1})).on("change",".local_wsmanager_external_function_handle_select select",(function(event){var $this=jQuery(this),parent=$this.closest(".local_wsmanager_external_function_handle_select"),webserviceid=parseInt(parent.data("webserviceid")),functionname=parent.data("functionname"),params=ctx.local_wsmanager_webservice_functions_get_params(webserviceid,functionname,sep1,sep2,sep3,sep4),method=jQuery("#local_wsmanager_external_function_handle_method_"+webserviceid+"_"+functionname+" select").val(),protocol=jQuery("#local_wsmanager_external_function_handle_protocol_"+webserviceid+"_"+functionname+" select").val(),restformat=jQuery("#local_wsmanager_external_function_handle_restformat_"+webserviceid+"_"+functionname+" select").val(),token=jQuery("#local_wsmanager_external_function_handle_token_"+webserviceid+"_"+functionname+" select option:selected").text();if("protocol"===parent.data("instance"))"rest"!=$this.val()?jQuery("#local_wsmanager_external_function_handle_restformat_row_"+webserviceid+"_"+functionname).hide():jQuery("#local_wsmanager_external_function_handle_restformat_row_"+webserviceid+"_"+functionname).show();return ctx.local_wsmanager_request_info(webserviceid,functionname,params,method,protocol,restformat,token)})).on("blur",".local_wsmanager_webservice_function_param_value input,.local_wsmanager_webservice_function_param_value textarea",(function(event){event.preventDefault();var parent=jQuery(this).closest(".local_wsmanager_webservice_function_param_value"),webserviceid=parseInt(parent.data("webserviceid")),functionname=parent.data("functionname"),params=ctx.local_wsmanager_webservice_functions_get_params(webserviceid,functionname,sep1,sep2,sep3,sep4),method=jQuery("#local_wsmanager_external_function_handle_method_"+webserviceid+"_"+functionname+" select").val(),protocol=jQuery("#local_wsmanager_external_function_handle_protocol_"+webserviceid+"_"+functionname+" select").val(),restformat=jQuery("#local_wsmanager_external_function_handle_restformat_"+webserviceid+"_"+functionname+" select").val(),token=jQuery("#local_wsmanager_external_function_handle_token_"+webserviceid+"_"+functionname+" select option:selected").text();return ctx.local_wsmanager_request_info(webserviceid,functionname,params,method,protocol,restformat,token)})).on("click",".local_wsmanager_external_function_handle",(function(event){event.preventDefault();var $this=jQuery(this),webserviceid=parseInt($this.data("webserviceid")),functionname=$this.data("functionname"),token=jQuery("#local_wsmanager_external_function_handle_token_"+webserviceid+"_"+functionname+" select option:selected").text(),params=ctx.local_wsmanager_webservice_functions_get_params(webserviceid,functionname,sep1,sep2,sep3,sep4),method=jQuery("#local_wsmanager_external_function_handle_method_"+webserviceid+"_"+functionname+" select").val(),protocol=jQuery("#local_wsmanager_external_function_handle_protocol_"+webserviceid+"_"+functionname+" select").val(),restformat=jQuery("#local_wsmanager_external_function_handle_restformat_"+webserviceid+"_"+functionname+" select").val();return ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:M.str.webservice.execute,body:M.str.webservice.execute+" <strong>"+functionname+"</strong><br />"+M.str.moodle.areyousure}).then((function(modal){modal.setButtonText("save",M.str.moodle.yes),modal.getRoot().on(ModalEvents.save,(function(e){e.preventDefault(),ajax.call([{methodname:"local_wsmanager_external_function_handle",args:{webserviceid:webserviceid,functionname:functionname,token:token,params:params,method:method,moodlewsprotocol:protocol,moodlewsrestformat:restformat}}])[0].then((function(res){jQuery("#local_wsmanager_external_function_handle_response_content_"+webserviceid+"_"+functionname).html(res),jQuery("#local_wsmanager_external_function_handle_response_"+webserviceid+"_"+functionname).show()})),modal.hide()})),modal.getRoot().on(ModalEvents.cancel,(function(){modal.hide()})),modal.show()})),!1})).on("click",".local_wsmanager_webservice_name_update",(function(event){event.preventDefault();var $this=jQuery(this),webserviceid=parseInt($this.data("webserviceid")),name=jQuery("#local_wsmanager_webservice_name_"+webserviceid).val();return ajax.call([{methodname:"local_wsmanager_webservice_rename",args:{webserviceid:webserviceid,name:name}}])[0].then((function(res){ModalFactory.create({type:ModalFactory.types.DEFAULT,title:M.str.moodle.summary,body:res?M.str.moodle.success:M.str.moodle.error}).then((function(modal){modal.getRoot().on(ModalEvents.cancel,(function(){modal.hide()})),modal.show()})),res&&jQuery("#local_wsmanager_tab_link_webservice_"+webserviceid).html(name)})),!1}))}}}));

//# sourceMappingURL=base_mdl32.min.js.map